<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>p5.js Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
  </head>
  <body>
    <script>
      const elements = [];

      function setup() {
        createCanvas(400, 400);
      }

      function draw() {
        background(220);
        fill(255, 0, 0);

        elements.forEach((element) => {
          if (element.elementType === "circle") {
            circle(element.x, element.y, element.r);
          } else if (element.elementType === "line") {
            line(element.x1, element.y1, element.x2, element.y2);
          } else {
            console.log("unknown element type");
          }
        });
      }

      // create a websocket client
      // the commands that the client can receive are:
      // - add: { "command": "addElement", "payload": { "elementType": "circle", "x": 10, "y": 30, "r": 10 }, "timestamp": 123456789 } - the client should return the index of the element
      // - remove: { "command": "removeElement", "payload": { "index": 0 }, "timestamp": 123456789 }
      // - update: { "command": "updateElement", "payload": { "index": 0, "x": 10, "y": 40, "r": 20 }, "timestamp": 123456789 }

      const ws = new WebSocket("ws://localhost:1234");

      ws.onopen = () => {
        console.log("connected");
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.command === "addElement") {
          const index = elements.push(data.payload) - 1;
          const response = {
            type: "response",
            command: "addElement",
            payload: {
              index,
            },
            timestamp: data.timestamp,
          };
          ws.send(JSON.stringify(response));
        } else if (data.command === "removeElement") {
          elements.splice(data.payload.index, 1);
          const response = {
            type: "response",
            command: "removeElement",
            payload: {
              index: data.payload.index,
            },
            timestamp: data.timestamp,
          };
          ws.send(JSON.stringify(response));
        } else if (data.command === "updateElement") {
          const element = elements[data.payload.index];
          element.x = data.payload.x;
          element.y = data.payload.y;
          element.r = data.payload.r;
          const response = {
            type: "response",
            command: "updateElement",
            payload: {
              index: data.payload.index,
            },
            timestamp: data.timestamp,
          };
          ws.send(JSON.stringify(response));
        } else {
          console.log("unknown command");
        }
      };
    </script>
  </body>
</html>
